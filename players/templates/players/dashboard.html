{% extends "base.html" %}
{% load player_extras %}
{% block title %}Players – ViolaLab{% endblock %}
{% block extra_css %}
  <style>
    .filter-grid {
      display: grid;
      gap: 1rem;
    }
    @media (min-width: 768px) {
      .filter-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    .filter-grid .full-span {
      grid-column: 1 / -1;
    }
    .chart-card + .chart-card {
      margin-top: 1.5rem;
    }
    .player-meta + .player-meta {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--bs-border-color);
    }
    .player-meta-name {
      font-weight: 600;
    }
    .metric-category + .metric-category {
      margin-top: 1rem;
    }
    .metric-group + .metric-group {
      margin-top: 1.5rem;
      border-top: 1px solid var(--bs-border-color);
      padding-top: 1.5rem;
    }
    .metric-label {
      font-weight: 600;
      display: block;
    }
    .metrics-accordion details {
      border: 1px solid var(--bs-border-color);
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      background-color: var(--bs-body-bg);
    }
    .metrics-accordion details + details {
      margin-top: 0.75rem;
    }
    .metrics-accordion summary {
      cursor: pointer;
      font-weight: 600;
      list-style: none;
    }
    .metrics-accordion summary::-webkit-details-marker {
      display: none;
    }
    .metrics-accordion summary::after {
      content: "▾";
      float: right;
      transition: transform 0.2s ease;
    }
    .metrics-accordion details[open] summary::after {
      transform: rotate(180deg);
    }
    .metric-checkbox-grid {
      margin-top: 0.75rem;
      display: grid;
      gap: 0.5rem 1rem;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    .metric-checkbox .metric-label {
      font-weight: 500;
    }
    .metric-checkbox small {
      display: block;
    }
  </style>
{% endblock %}
{% block content %}
  <h1 class="mb-4">Players</h1>
  <form method="get" class="card mb-4">
    <div class="card-header">Auswahl</div>
    <div class="card-body filter-grid">
      <div>
        <label class="form-label" for="id_competition">Liga / Saison</label>
        <select id="id_competition" class="form-select" name="competition">
          {% for comp in competition_choices %}
            <option value="{{ comp.key }}" {% if comp.key == selected_competition %}selected{% endif %}>
              {{ comp.label }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label" for="id_position">Position</label>
        <select id="id_position" class="form-select" name="position">
          <option value="" {% if not selected_position %}selected{% endif %}>Alle Positionen</option>
          {% for position in positions %}
            <option value="{{ position.value }}" {% if position.value == selected_position %}selected{% endif %}>
              {{ position.label|default:position.value }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label" for="id_player_search">Spieler vergleichen</label>
        <input
          type="search"
          id="id_player_search"
          class="form-control mb-2"
          placeholder="Spieler filtern..."
          autocomplete="off"
        />
        <select id="id_players" class="form-select" name="players" multiple size="8">
          {% for player in players %}
            <option value="{{ player.player_id }}" {% if player.player_id|stringformat:"s" in selected_players %}selected{% endif %}>
              {{ player.player_name }}
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">Mehrfachauswahl mit Strg/Cmd möglich.</small>
      </div>
      <div class="full-span">
        <label class="form-label">Season-Metriken</label>
        <p class="text-muted small mb-2">Wähle die Kennzahlen aus, die in der Saison-Tabelle und im Radar angezeigt werden sollen.</p>
        <div class="metrics-accordion">
          {% for category in season_metric_options %}
            <details class="metric-panel" {% if forloop.first %}open{% endif %}>
              <summary>{{ category.label }}</summary>
              <div class="metric-checkbox-grid">
                {% for metric in category.metrics %}
                  <label class="form-check metric-checkbox">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="season_metrics"
                      value="{{ metric.key }}"
                      {% if metric.key in selected_season_metrics %}checked{% endif %}
                    />
                    <span class="form-check-label">
                      <span class="metric-label">{{ metric.label }}</span>
                      {% if metric.legend %}
                        <small class="text-muted">{{ metric.legend }}</small>
                      {% endif %}
                    </span>
                  </label>
                {% endfor %}
              </div>
            </details>
          {% endfor %}
        </div>
        <small class="text-muted">Mindestens eine Kennzahl auswählen.</small>
      </div>
      <div class="full-span">
        <label class="form-label">Match-Metriken</label>
        <p class="text-muted small mb-2">Bestimme, welche Match-Kennzahlen in den Verlaufsgrafiken erscheinen.</p>
        <div class="metrics-accordion">
          {% for category in match_metric_options %}
            <details class="metric-panel" {% if forloop.first %}open{% endif %}>
              <summary>{{ category.label }}</summary>
              <div class="metric-checkbox-grid">
                {% for metric in category.metrics %}
                  <label class="form-check metric-checkbox">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="match_metrics"
                      value="{{ metric.key }}"
                      {% if metric.key in selected_match_metrics %}checked{% endif %}
                    />
                    <span class="form-check-label">
                      <span class="metric-label">{{ metric.label }}</span>
                      {% if metric.legend %}
                        <small class="text-muted">{{ metric.legend }}</small>
                      {% endif %}
                    </span>
                  </label>
                {% endfor %}
              </div>
            </details>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="card-footer text-end">
      <button class="btn btn-primary" type="submit">Aktualisieren</button>
    </div>
  </form>
  {% if not competition_choices %}
    <div class="alert alert-warning">Keine Daten vorhanden.</div>
  {% else %}
    {% if not season_stats %}
      <div class="alert alert-info">Bitte eine Liga und mindestens einen Spieler auswählen.</div>
    {% else %}
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card mb-4">
            <div class="card-header">Season Snapshot</div>
            <div class="card-body table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Spieler</th>
                    {% for metric, label, fmt in season_metrics %}
                      <th class="text-end">{{ label }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for stat in season_stats %}
                    <tr>
                      <th scope="row">
                        <div class="player-meta-name">{{ stat.player_name }}</div>
                        <div class="text-muted small">
                          {{ stat.team_name|default:"–" }}
                          {% with stat.primary_position|position_label as pos %}
                            {% if pos %} · {{ pos }}{% endif %}
                          {% endwith %}
                        </div>
                      </th>
                      {% for metric, label, fmt in season_metrics %}
                        {% with value=stat|attr:metric %}
                          <td class="text-end">
                            {% if value is not None %}
                              {% if fmt == "percent" %}
                                {{ value|floatformat:2 }}
                              {% else %}
                                {{ value|floatformat:2 }}
                              {% endif %}
                            {% else %}
                              –
                            {% endif %}
                          </td>
                        {% endwith %}
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">Season Vergleich (Chart)</div>
            <div class="card-body">
              <canvas id="season-chart" height="160"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Match-Performance</div>
            <div class="card-body">
              <div class="row gy-4">
                {% for metric, label in match_metrics %}
                  <div class="col-12">
                    <h3 class="h6 mb-3">{{ label }}</h3>
                    <canvas id="match-chart-{{ metric }}" height="160"></canvas>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card mb-4 h-100">
            <div class="card-header">Spieler-Infos</div>
            <div class="card-body">
              {% if selected_player_meta %}
                {% for player in selected_player_meta %}
                  <div class="player-meta">
                    <div class="player-meta-name">{{ player.player_name }}</div>
                    <dl class="row small mb-0">
                      {% for key, label in player_info_fields %}
                        <dt class="col-5 text-muted">{{ label }}</dt>
                        <dd class="col-7">{{ player|dict_get:key|default:"–" }}</dd>
                      {% endfor %}
                    </dl>
                  </div>
                {% endfor %}
              {% else %}
                <p class="text-muted mb-0">Noch keine Spieler ausgewählt.</p>
              {% endif %}
            </div>
          </div>
          <div class="card">
            <div class="card-header">Metrik-Kategorien</div>
            <div class="card-body">
              <div class="metric-groups">
                <div class="metric-group">
                  <div class="text-uppercase text-muted small mb-2">Saison</div>
                  {% for category in season_category_sections %}
                    <div class="metric-category mb-3">
                      <div class="fw-semibold mb-1">{{ category.label }}</div>
                      <ul class="list-unstyled small mb-0">
                        {% for metric in category.metrics %}
                          <li>
                            <span class="metric-label">{{ metric.label }}</span>
                            {% if metric.legend %}
                              <span class="text-muted">{{ metric.legend }}</span>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% empty %}
                    <p class="text-muted small mb-0">Keine Saison-Metriken ausgewählt.</p>
                  {% endfor %}
                </div>
                <div class="metric-group">
                  <div class="text-uppercase text-muted small mb-2">Match</div>
                  {% for category in match_category_sections %}
                    <div class="metric-category mb-3">
                      <div class="fw-semibold mb-1">{{ category.label }}</div>
                      <ul class="list-unstyled small mb-0">
                        {% for metric in category.metrics %}
                          <li>
                            <span class="metric-label">{{ metric.label }}</span>
                            {% if metric.legend %}
                              <span class="text-muted">{{ metric.legend }}</span>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% empty %}
                    <p class="text-muted small mb-0">Keine Match-Metriken ausgewählt.</p>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endblock %}
{% block extra_js %}
  {{ block.super }}
  <script>
    (function() {
      const searchInput = document.getElementById('id_player_search');
      const select = document.getElementById('id_players');
      if (searchInput && select) {
        searchInput.addEventListener('input', () => {
          const term = searchInput.value.trim().toLowerCase();
          [...select.options].forEach(option => {
            const match = option.text.toLowerCase().includes(term);
            option.hidden = !match;
          });
        });
      }
    })();
    const seasonChartData = JSON.parse('{{ season_chart_json|escapejs }}');
    if (seasonChartData.labels && seasonChartData.labels.length) {
      const metricFormats = seasonChartData.formats || [];
      const ctx = document.getElementById('season-chart');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: seasonChartData.labels,
            datasets: seasonChartData.datasets.map((dataset, idx) => ({
              label: dataset.label,
              data: dataset.data,
              backgroundColor: `hsla(${(idx * 70) % 360}, 70%, 55%, 0.6)`,
              borderColor: `hsla(${(idx * 70) % 360}, 70%, 35%, 1)`,
              borderWidth: 1,
            })),
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const format = metricFormats[context.dataIndex];
                    const val = context.parsed.y;
                    if (val == null) {
                      return `${context.dataset.label}: –`;
                    }
                    if (format === 'percent') {
                      return `${context.dataset.label}: ${(val * 100).toFixed(1)}%`;
                    }
                    return `${context.dataset.label}: ${val.toFixed(2)}`;
                  }
                }
              }
            }
          }
        });
      }
    }
    const matchChartData = JSON.parse('{{ match_chart_json|escapejs }}');
    if (matchChartData.labels && matchChartData.labels.length) {
      {% for metric, label in match_metrics %}
        (function() {
          const canvas = document.getElementById('match-chart-{{ metric }}');
          if (!canvas) {
            return;
          }
          const payload = matchChartData.metrics['{{ metric }}'];
          if (!payload) {
            return;
          }
          new Chart(canvas, {
            type: 'line',
            data: {
              labels: matchChartData.labels,
              datasets: payload.datasets.map((dataset, idx) => ({
                label: dataset.label,
                data: dataset.data,
                tension: 0.3,
                spanGaps: true,
                borderWidth: 2,
                borderColor: `hsla(${(idx * 70) % 360}, 65%, 45%, 1)`,
                backgroundColor: `hsla(${(idx * 70) % 360}, 65%, 45%, 0.15)`,
                pointRadius: 3,
              })),
            },
            options: {
              responsive: true,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      if (context.parsed.y == null) {
                        return `${context.dataset.label}: –`;
                      }
                      return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                }
              }
            }
          });
        })();
      {% endfor %}
    }
  </script>
{% endblock %}